---
import _ from 'lodash';
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { AlbumPage } from '../../templates/AlbumPage';
import type { Photo } from '../../types/Photo';
import { undefined } from 'astro:schema';

// @todo: Report missing photos

type Props = {
	album: CollectionEntry<'series'>;
	photos: Photo[];
};

export async function getStaticPaths() {
	const seriesEntries = await getCollection('series');
	const photosEntries = await getCollection('photos');
	const allPhotos = photosEntries.map((x) => x.data);

	return seriesEntries.map((album) => {
		// Convert Markdown list to an array of photo names
		const photoNames = album.body.split('\n').map((x) =>
			x
				// Remove Markdown list marker
				.replace(/^-\s*/, '')
				// Unescape characters
				.replaceAll('\\', '')
		);

		// Keep only photos from the current series
		const photos = allPhotos.filter((x) => photoNames.includes(x.name));

		// Report missing photos
		if (photos.length < photoNames.length) {
			for (const name of photoNames) {
				if (photos.some((x) => x.name === name) === false) {
					console.error(
						`⛔️ Photo ${name} not found in series ${album.data.title}`
					);
				}
			}
		}

		// Sort by capture date
		const sortedPhotos = _.orderBy(photos, ['timestamp'], ['desc']);
		return {
			params: { slug: album.slug },
			props: {
				album,
				photos: sortedPhotos,
			},
		};
	});
}

const { album, photos } = Astro.props;
---

<Layout
	url={`/series/${album.slug}/`}
	title={album.data.title}
	pageTitle={album.data.pageTitle}
	description={album.data.description}
	component={AlbumPage}
	props={{
		photos,
	}}
/>
