---
import _ from 'lodash';
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { AlbumPage } from '../../templates/AlbumPage';
import type { Photo } from '../../types/Photo';

// @todo: Report missing photos

type Props = {
	page: CollectionEntry<'series'>;
	photos: Photo[];
};

export async function getStaticPaths() {
	const seriesEntries = await getCollection('series');
	const photosEntries = await getCollection('photos');
	const allPhotos = photosEntries.map((x) => x.data);

	return seriesEntries.map((page) => {
		// Convert Markdown list to an array of photo names
		const photoNames = page.body.split('\n').map((x) => x.replace(/^-\s*/, ''));
		// Keep only photos from the current series
		const photos = allPhotos.filter((x) => photoNames.includes(x.name));
		// Sort by data
		const sortedPhotos = _.orderBy(photos, ['timestamp'], ['desc']);
		return {
			params: { slug: page.slug },
			props: {
				page,
				photos: sortedPhotos,
			},
		};
	});
}

const { page, photos } = Astro.props;
---

<Layout
	url={`/series/${page.slug}/`}
	title={page.data.title}
	pageTitle={page.data.pageTitle}
	description={page.data.description}
	component={AlbumPage}
	props={{
		photos,
	}}
/>
