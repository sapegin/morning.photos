---
import _ from 'lodash';
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import { GalleryPage } from '../templates/GalleryPage';

const entries = await getCollection('photos');

// Keep only photos with 5-star rating
const fiveStarPhotos = entries.map((x) => x.data).filter((x) => x.rating === 5);

// Sort by date
const sortedFiveStarPhotos = _.orderBy(fiveStarPhotos, ['timestamp'], ['desc']);

// Group by aspect ratio, but keep all horizontal photos in a single group
const photosByAspectRatio = _.groupBy(sortedFiveStarPhotos, (x) => {
	const aspectRatio = x.width / x.height;
	return aspectRatio < 1 ? aspectRatio : 0;
});

// Split each group of vertical photos into pairs
const photoPairs = Object.entries(photosByAspectRatio).flatMap(
	([aspectRatio, photos]) => {
		return _.chunk(photos, aspectRatio === '0' ? 1 : 2);
	}
);

// Sort by the date of the first photo in the pair
const sortedPhotos = _.orderBy(photoPairs, [(x) => x[0].timestamp], ['desc']);
---

<Layout
	url="/photos/"
	title="Photos"
	pageTitle="Favorite photos by Artem Sapegin"
	description="Artem Sapeginâ€™s favorite photos: landscapes, travel, cityscapes, nature, street"
	component={GalleryPage}
	props={{ photos: sortedPhotos }}
/>
